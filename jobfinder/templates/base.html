<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Job Finder{% endblock %}</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home:index' %}">
                <strong>Job Finder</strong>
            </a>
            <input type="checkbox" id="navbar-toggle" class="navbar-toggle-checkbox">
            <label for="navbar-toggle" class="navbar-toggler">
                <span class="navbar-toggler-icon"></span>
            </label>
            <div class="navbar-menu" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'jobs:job_list' %}">Jobs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'home:dashboard' %}">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <span class="navbar-text me-3">Welcome, {{ user.email }}!</span>
                        </li>
                        <li class="nav-item">
                            <form method="post" action="{% url 'authentication:logout' %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-light btn-sm">Logout</button>
                            </form>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'jobs:job_list' %}">Jobs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'home:index' %}">Home</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid p-0">
        {% if messages %}
            <div class="container mt-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% block content %}
        {% endblock %}
    </main>

    <!-- Persistent Chat Button (only show if authenticated) -->
    {% if user.is_authenticated %}
    <button id="chatFloatingBtn" class="btn btn-primary rounded-circle shadow-lg" 
            style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1050;"
            onclick="toggleChatPanel()">
        <i class="fas fa-comments fa-lg"></i>
        <span id="chatBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
            0
        </span>
    </button>

    <!-- Chat Panel -->
    <div id="chatPanel" class="card shadow-lg" style="position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; z-index: 1050; display: none;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-comments"></i> Messages</h6>
            <button class="btn btn-sm btn-link text-white" onclick="toggleChatPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="card-body p-0" style="overflow-y: auto;">
            <div id="conversationsList" class="list-group list-group-flush">
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Loading conversations...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        #chatFloatingBtn:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        
        .conversation-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .conversation-item:hover {
            background-color: #f8f9fa;
        }
        
        .conversation-item.unread {
            background-color: #e3f2fd;
        }
    </style>

    <script>
        let chatPanelOpen = false;
        
        function toggleChatPanel() {
            chatPanelOpen = !chatPanelOpen;
            const panel = document.getElementById('chatPanel');
            panel.style.display = chatPanelOpen ? 'block' : 'none';
            
            if (chatPanelOpen) {
                loadConversations();
            }
        }
        
        function loadConversations() {
            // This will be implemented to load all application conversations
            fetch('/jobs/ajax/conversations/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayConversations(data.conversations);
                    updateChatBadge(data.unread_count);
                }
            })
            .catch(error => {
                console.error('Error loading conversations:', error);
            });
        }
        
        function displayConversations(conversations) {
            const container = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No conversations yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = conversations.map(conv => `
                <div class="conversation-item list-group-item ${conv.unread_count > 0 ? 'unread' : ''}" 
                     onclick="openConversation(${conv.application_id})">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${conv.job_title}</h6>
                            <small class="text-muted">${conv.other_party}</small>
                        </div>
                        ${conv.unread_count > 0 ? `<span class="badge bg-primary rounded-pill">${conv.unread_count}</span>` : ''}
                    </div>
                    ${conv.last_message ? `<p class="mb-1 small text-truncate">${conv.last_message}</p>` : ''}
                    <small class="text-muted">${conv.last_message_time}</small>
                </div>
            `).join('');
        }
        
        function updateChatBadge(count) {
            const badge = document.getElementById('chatBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function openConversation(applicationId) {
            // Open the existing message modal functionality
            {% if user.userprofile.user_type == 'job_seeker' %}
                if (typeof openJobSeekerMessages === 'function') {
                    openJobSeekerMessages(applicationId);
                }
            {% else %}
                if (typeof openMessages === 'function') {
                    openMessages(applicationId);
                }
            {% endif %}
            toggleChatPanel();
        }
        
        // Load initial badge count
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                fetch('/jobs/ajax/unread-count/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateChatBadge(data.unread_count);
                    }
                });
            });
        } else {
            fetch('/jobs/ajax/unread-count/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateChatBadge(data.unread_count);
                }
            });
        }
        
        // Refresh badge count every 30 seconds
        setInterval(() => {
            fetch('/jobs/ajax/unread-count/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateChatBadge(data.unread_count);
                }
            });
        }, 30000);
    </script>
    {% endif %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>